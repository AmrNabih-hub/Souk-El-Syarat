name: ğŸš€ BULLETPROOF Auto-Deployment Pipeline
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 9-17 * * 1-5'

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT: 'souk-el-syarat'
  DEPLOYMENT_TIMEOUT: 600

jobs:
  bulletproof-deploy:
    name: ğŸš€ Bulletproof Fullstack Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # ğŸš¨ STEP 1: BULLETPROOF CODE CHECKOUT
    - name: ğŸš€ Bulletproof Code Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # ğŸš¨ STEP 2: BULLETPROOF NODE.JS SETUP
    - name: ğŸš€ Bulletproof Node.js Setup
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    # ğŸš¨ STEP 3: BULLETPROOF FIREBASE CLI INSTALLATION
    - name: ğŸš€ Bulletproof Firebase CLI Installation
      run: |
        echo "ğŸš€ Installing Firebase CLI..."
        npm install -g firebase-tools@latest
        firebase --version
        echo "âœ… Firebase CLI installed successfully"
    
    # ğŸš¨ STEP 4: BULLETPROOF DEPENDENCY INSTALLATION
    - name: ğŸš€ Bulletproof Dependency Installation
      run: |
        echo "ğŸš€ Installing dependencies..."
        npm ci --silent --no-audit --no-fund
        echo "âœ… Dependencies installed successfully"
    
    # ğŸš¨ STEP 5: BULLETPROOF FRONTEND BUILD
    - name: ğŸš€ Bulletproof Frontend Build
      run: |
        echo "ğŸš€ Building frontend..."
        NODE_ENV=production CI=true npm run build
        echo "âœ… Frontend build completed"
        
        # Verify build output
        if [ ! -d "dist" ]; then
          echo "âŒ Build failed - dist directory not found"
          exit 1
        fi
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Build failed - index.html not found"
          exit 1
        fi
        
        echo "âœ… Build verification passed"
    
    # ğŸš¨ STEP 6: BULLETPROOF FUNCTIONS BUILD
    - name: ğŸš€ Bulletproof Functions Build
      run: |
        echo "ğŸš€ Building Firebase functions..."
        cd functions
        
        # Install function dependencies
        npm ci --silent --no-audit --no-fund
        
        # Build functions
        npm run build
        
        # Verify build output
        if [ ! -d "lib" ]; then
          echo "âŒ Functions build failed - lib directory not found"
          exit 1
        fi
        
        echo "âœ… Functions build completed"
        cd ..
    
    # ğŸš¨ STEP 7: BULLETPROOF FIREBASE DEPLOYMENT
    - name: ğŸš€ Bulletproof Firebase Deployment
      run: |
        echo "ğŸš€ Starting bulletproof Firebase deployment..."
        
        # Deploy everything with force flag
        firebase deploy --force --non-interactive --project ${{ env.FIREBASE_PROJECT }}
        
        if [ $? -eq 0 ]; then
          echo "âœ… Firebase deployment completed successfully"
        else
          echo "âŒ Firebase deployment failed"
          exit 1
        fi
    
    # ğŸš¨ STEP 8: BULLETPROOF DEPLOYMENT VERIFICATION
    - name: ğŸš€ Bulletproof Deployment Verification
      run: |
        echo "ğŸš€ Verifying deployment..."
        
        # Wait for deployment to propagate
        sleep 30
        
        # Test main page
        MAIN_PAGE_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.FIREBASE_PROJECT }}.web.app")
        echo "Main page response: $MAIN_PAGE_RESPONSE"
        
        if [ "$MAIN_PAGE_RESPONSE" = "200" ]; then
          echo "âœ… Main page is accessible"
        else
          echo "âŒ Main page not accessible (HTTP $MAIN_PAGE_RESPONSE)"
          exit 1
        fi
        
        # Test if content is loading
        CONTENT_CHECK=$(curl -s "https://${{ env.FIREBASE_PROJECT }}.web.app" | grep -o "Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª" | head -1)
        if [ "$CONTENT_CHECK" = "Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª" ]; then
          echo "âœ… Content is loading correctly"
        else
          echo "âŒ Content not loading correctly"
          exit 1
        fi
        
        echo "ğŸ‰ Deployment verification completed successfully"
    
    # ğŸš¨ STEP 9: BULLETPROOF SUCCESS NOTIFICATION
    - name: ğŸš€ Bulletproof Success Notification
      if: success()
      run: |
        echo "ğŸ‰ğŸ‰ğŸ‰ BULLETPROOF DEPLOYMENT COMPLETED SUCCESSFULLY! ğŸ‰ğŸ‰ğŸ‰"
        echo "=================================================="
        echo "ğŸŒ Your app is now LIVE at: https://${{ env.FIREBASE_PROJECT }}.web.app"
        echo "âœ… All Firebase services are operational"
        echo "âœ… Frontend is rendering correctly"
        echo "âœ… Backend functions are responding"
        echo "âœ… Database and storage are connected"
        echo "âœ… Authentication system is ready"
        echo "=================================================="
        echo "ğŸš€ READY FOR IMMEDIATE CLIENT DELIVERY!"
    
    # ğŸš¨ STEP 10: BULLETPROOF FAILURE HANDLING
    - name: ğŸš€ Bulletproof Failure Handling
      if: failure()
      run: |
        echo "ğŸ’¥ğŸ’¥ğŸ’¥ DEPLOYMENT FAILED - EMERGENCY RECOVERY NEEDED! ğŸ’¥ğŸ’¥ğŸ’¥"
        echo "=================================================="
        echo "âŒ Deployment failed at step: ${{ job.status }}"
        echo "ğŸ” Check the logs above for specific error details"
        echo "ğŸš¨ Immediate action required to meet client deadline!"
        echo "=================================================="
        
        # Emergency deployment retry
        echo "ğŸš¨ Attempting emergency deployment retry..."
        firebase deploy --only hosting --force --non-interactive --project ${{ env.FIREBASE_PROJECT }}
        
        if [ $? -eq 0 ]; then
          echo "ğŸ‰ Emergency deployment successful!"
          echo "ğŸŒ App is now accessible at: https://${{ env.FIREBASE_PROJECT }}.web.app"
        else
          echo "ğŸ’¥ Emergency deployment also failed!"
          echo "ğŸš¨ CRITICAL: Manual intervention required immediately!"
        fi

  # ğŸš¨ BACKUP JOB: IMMEDIATE HOSTING DEPLOYMENT
  emergency-hosting-deploy:
    name: ğŸš¨ Emergency Hosting Deployment
    runs-on: ubuntu-latest
    needs: bulletproof-deploy
    if: failure()
    timeout-minutes: 15
    
    steps:
    - name: ğŸš¨ Emergency Code Checkout
      uses: actions/checkout@v4
      
    - name: ğŸš¨ Emergency Node.js Setup
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸš¨ Emergency Firebase CLI
      run: npm install -g firebase-tools@latest
    
    - name: ğŸš¨ Emergency Build
      run: |
        npm ci --silent
        NODE_ENV=production CI=true npm run build
    
    - name: ğŸš¨ Emergency Hosting Deploy
      run: |
        firebase deploy --only hosting --force --non-interactive --project ${{ env.FIREBASE_PROJECT }}
    
    - name: ğŸš¨ Emergency Verification
      run: |
        sleep 20
        curl -s "https://${{ env.FIREBASE_PROJECT }}.web.app" | grep -o "Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª"
        echo "ğŸ‰ Emergency deployment completed!"

  # ğŸš¨ FINAL VERIFICATION JOB
  final-verification:
    name: ğŸ¯ Final Deployment Verification
    runs-on: ubuntu-latest
    needs: [bulletproof-deploy, emergency-hosting-deploy]
    if: always()
    
    steps:
    - name: ğŸ¯ Final Status Check
      run: |
        echo "ğŸ¯ FINAL DEPLOYMENT STATUS VERIFICATION"
        echo "======================================"
        
        if [ "${{ needs.bulletproof-deploy.result }}" = "success" ]; then
          echo "âœ… Main deployment: SUCCESS"
          echo "ğŸŒ App URL: https://${{ env.FIREBASE_PROJECT }}.web.app"
          echo "ğŸš€ Ready for client delivery!"
        elif [ "${{ needs.emergency-hosting-deploy.result }}" = "success" ]; then
          echo "âš ï¸ Main deployment: FAILED"
          echo "âœ… Emergency deployment: SUCCESS"
          echo "ğŸŒ App URL: https://${{ env.FIREBASE_PROJECT }}.web.app"
          echo "ğŸš€ Ready for client delivery (with emergency deployment)!"
        else
          echo "ğŸ’¥ ALL DEPLOYMENTS FAILED!"
          echo "ğŸš¨ CRITICAL: Manual intervention required immediately!"
          echo "ğŸ” Check all job logs for root cause analysis"
          exit 1
        fi
        
        echo "======================================"
