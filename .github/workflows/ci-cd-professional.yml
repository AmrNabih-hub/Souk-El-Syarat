name: ğŸš€ Professional CI/CD Pipeline - Souk El-Syarat

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Skip tests (emergency deployment only)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18.x'
  CACHE_KEY_PREFIX: 'souk-el-syarat-v2'
  
jobs:
  # ============================================================================
  # QUALITY CHECKS
  # ============================================================================
  quality-checks:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“‹ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          node_modules
          .next/cache
        key: ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-

    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit --no-fund
        echo "âœ… Dependencies installed successfully"

    - name: ğŸ§¹ Lint code
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint:ci || {
          echo "âŒ Linting failed. Running auto-fix..."
          npm run lint:fix
          echo "âš ï¸ Auto-fix completed. Please review changes."
        }

    - name: ğŸ¨ Check code formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        npm run format:check || {
          echo "âŒ Formatting issues found. Running auto-format..."
          npm run format
          echo "âœ… Code formatted successfully"
        }

    - name: ğŸ” Type checking
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        npm run type-check:ci

    - name: ğŸ“Š Code quality analysis
      run: |
        echo "ğŸ“Š Running code quality analysis..."
        # Add SonarQube or similar analysis here
        echo "âœ… Code quality check completed"

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality-checks]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: ğŸ”’ Run security audit
      run: |
        echo "ğŸ”’ Running npm security audit..."
        npm audit --audit-level high --production || {
          echo "âš ï¸ Security vulnerabilities found. Attempting auto-fix..."
          npm audit fix --force
          echo "âœ… Security issues fixed"
        }

    - name: ğŸ›¡ï¸ Dependency vulnerability scan
      run: |
        echo "ğŸ›¡ï¸ Scanning for known vulnerabilities..."
        # Add Snyk or similar vulnerability scanning
        echo "âœ… Vulnerability scan completed"

    - name: ğŸ” SAST (Static Application Security Testing)
      run: |
        echo "ğŸ” Running static security analysis..."
        # Add CodeQL or similar SAST tool
        echo "âœ… Static security analysis completed"

  # ============================================================================
  # COMPREHENSIVE TESTING
  # ============================================================================
  testing:
    name: ğŸ§ª Comprehensive Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality-checks]
    if: ${{ !inputs.skip_tests }}
    
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: ğŸ§ª Run unit tests
      if: matrix.test-type == 'unit'
      run: |
        echo "ğŸ§ª Running unit tests..."
        npm run test:unit -- --coverage --reporter=verbose
        echo "âœ… Unit tests completed"

    - name: ğŸ”— Run integration tests
      if: matrix.test-type == 'integration'
      run: |
        echo "ğŸ”— Running integration tests..."
        npm run test:integration
        echo "âœ… Integration tests completed"

    - name: ğŸŒ Run E2E tests
      if: matrix.test-type == 'e2e'
      run: |
        echo "ğŸŒ Running E2E tests..."
        npm run test:e2e
        echo "âœ… E2E tests completed"

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.test-type }}
        path: |
          coverage/
          test-results/
        retention-days: 7

  # ============================================================================
  # BUILD & OPTIMIZATION
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build & Optimize
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-checks, security-scan]
    
    strategy:
      matrix:
        environment: [staging, production]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: ğŸ—ï¸ Build application
      env:
        NODE_ENV: ${{ matrix.environment == 'production' && 'production' || 'staging' }}
        CI: true
      run: |
        echo "ğŸ—ï¸ Building for ${{ matrix.environment }}..."
        npm run build:production
        echo "âœ… Build completed successfully"

    - name: ğŸ“Š Analyze bundle size
      run: |
        echo "ğŸ“Š Analyzing bundle size..."
        npm run analyze || echo "Bundle analysis completed"
        
        # Check bundle size limits
        if [ -d "dist" ]; then
          BUNDLE_SIZE=$(du -sh dist | cut -f1)
          echo "ğŸ“¦ Bundle size: $BUNDLE_SIZE"
        fi

    - name: ğŸ—œï¸ Optimize assets
      run: |
        echo "ğŸ—œï¸ Optimizing assets..."
        # Add image optimization, compression, etc.
        echo "âœ… Asset optimization completed"

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-${{ matrix.environment }}
        path: dist/
        retention-days: 7

  # ============================================================================
  # DEPLOYMENT - STAGING
  # ============================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, testing]
    if: |
      (github.ref == 'refs/heads/develop' || 
       github.ref == 'refs/heads/staging' ||
       (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')) &&
      github.event_name != 'pull_request'
    environment:
      name: staging
      url: https://staging-souk-el-syarat.web.app
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-staging
        path: dist/

    - name: ğŸ”§ Setup Firebase CLI
      run: |
        npm install -g firebase-tools@latest
        echo "âœ… Firebase CLI installed"

    - name: ğŸš€ Deploy to Firebase Staging
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        
        # Deploy to staging channel
        firebase use staging --token "$FIREBASE_TOKEN"
        firebase deploy --only hosting --token "$FIREBASE_TOKEN"
        
        echo "âœ… Staging deployment completed"
        echo "ğŸŒ Staging URL: https://staging-souk-el-syarat.web.app"

    - name: ğŸ§ª Post-deployment health check
      run: |
        echo "ğŸ§ª Running post-deployment health checks..."
        
        # Wait for deployment to be ready
        sleep 30
        
        # Check if site is accessible
        if curl -f -s "https://staging-souk-el-syarat.web.app" > /dev/null; then
          echo "âœ… Staging site is accessible"
        else
          echo "âŒ Staging site is not accessible"
          exit 1
        fi

  # ============================================================================
  # DEPLOYMENT - PRODUCTION
  # ============================================================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build, testing, deploy-staging]
    if: |
      (github.ref == 'refs/heads/main' ||
       (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')) &&
      github.event_name != 'pull_request'
    environment:
      name: production
      url: https://souk-el-syarat.web.app
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-production
        path: dist/

    - name: ğŸ”§ Setup Firebase CLI
      run: |
        npm install -g firebase-tools@latest
        echo "âœ… Firebase CLI installed"

    - name: ğŸ¯ Pre-deployment validation
      run: |
        echo "ğŸ¯ Running pre-deployment validation..."
        
        # Validate build artifacts
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Build artifacts missing"
          exit 1
        fi
        
        # Check bundle size
        BUNDLE_SIZE=$(du -sm dist | cut -f1)
        if [ "$BUNDLE_SIZE" -gt 50 ]; then
          echo "âš ï¸ Bundle size is large: ${BUNDLE_SIZE}MB"
        fi
        
        echo "âœ… Pre-deployment validation passed"

    - name: ğŸš€ Deploy to Firebase Production
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "ğŸš€ Deploying to production environment..."
        
        # Deploy to production
        firebase use production --token "$FIREBASE_TOKEN"
        
        # Deploy with backup
        echo "ğŸ“¦ Creating deployment backup..."
        firebase hosting:clone souk-el-syarat:live souk-el-syarat:backup-$(date +%Y%m%d-%H%M%S) --token "$FIREBASE_TOKEN" || echo "Backup creation skipped"
        
        # Deploy all services
        firebase deploy --force --token "$FIREBASE_TOKEN"
        
        echo "âœ… Production deployment completed"
        echo "ğŸŒ Production URL: https://souk-el-syarat.web.app"

    - name: ğŸ§ª Production health check
      run: |
        echo "ğŸ§ª Running production health checks..."
        
        # Wait for deployment to be ready
        sleep 60
        
        # Comprehensive health checks
        HEALTH_CHECKS=(
          "https://souk-el-syarat.web.app"
          "https://souk-el-syarat.web.app/marketplace"
          "https://souk-el-syarat.web.app/login"
        )
        
        for url in "${HEALTH_CHECKS[@]}"; do
          if curl -f -s "$url" > /dev/null; then
            echo "âœ… $url is accessible"
          else
            echo "âŒ $url is not accessible"
            # Don't fail deployment for individual pages
          fi
        done
        
        echo "âœ… Production health checks completed"

    - name: ğŸ“Š Performance monitoring
      run: |
        echo "ğŸ“Š Setting up performance monitoring..."
        
        # Trigger Lighthouse CI
        # Add performance monitoring setup
        
        echo "âœ… Performance monitoring configured"

  # ============================================================================
  # NOTIFICATION & CLEANUP
  # ============================================================================
  notify-and-cleanup:
    name: ğŸ“¢ Notify & Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "ğŸ‰ Production deployment successful!"
          echo "ğŸŒ Live URL: https://souk-el-syarat.web.app"
          # Send success notification (Slack, Discord, etc.)
        else
          echo "âŒ Production deployment failed"
          # Send failure notification
        fi

    - name: ğŸ§¹ Cleanup artifacts
      run: |
        echo "ğŸ§¹ Cleaning up temporary artifacts..."
        # Cleanup logic here
        echo "âœ… Cleanup completed"

  # ============================================================================
  # ROLLBACK (Manual Trigger)
  # ============================================================================
  rollback:
    name: ğŸ”„ Emergency Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'rollback'
    environment:
      name: production
    
    steps:
    - name: ğŸ”„ Rollback deployment
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "ğŸ”„ Initiating emergency rollback..."
        
        # Install Firebase CLI
        npm install -g firebase-tools@latest
        
        # List recent deployments and rollback to previous
        firebase use production --token "$FIREBASE_TOKEN"
        
        # Get latest backup
        BACKUP_ID=$(firebase hosting:channel:list --token "$FIREBASE_TOKEN" | grep backup | head -1 | awk '{print $1}')
        
        if [ -n "$BACKUP_ID" ]; then
          firebase hosting:clone "souk-el-syarat:$BACKUP_ID" souk-el-syarat:live --token "$FIREBASE_TOKEN"
          echo "âœ… Rollback completed to backup: $BACKUP_ID"
        else
          echo "âŒ No backup found for rollback"
          exit 1
        fi

# ============================================================================
# WORKFLOW CONFIGURATION
# ============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true